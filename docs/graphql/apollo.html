<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="twitter:card" content="summary" />
    <meta property="og:url" content="https://japanese-document.github.io/memo/graphql/apollo.html" />
    <meta property="og:title" content="Apolloメモ" />
    <meta property="og:description" content="リクエスト手動でデータを取得するにはrefetchを使うか、useLazyQueryを使う。useSuspenseQueryを&lt;Suspense&gt;の子コンポーネントで使うと、リクエスト中はfallbackが表示される。&lt;Suspense&gt;の中に&lt;Suspense&gt;を入れると各&lt;Suspense&amp;g" />
    <meta property="og:image" content="https://japanese-document.github.io/memo/images/favicon.png" />
    <meta name="theme-color" content="#f1f7fe" />
    <meta name="description" content="リクエスト手動でデータを取得するにはrefetchを使うか、useLazyQueryを使う。useSuspenseQueryを&lt;Suspense&gt;の子コンポーネントで使うと、リクエスト中はfallbackが表示される。&lt;Suspense&gt;の中に&lt;Suspense&gt;を入れると各&lt;Suspense&amp;g" />
    <meta name="Hatena::Bookmark" content="nocomment" />
    <link rel="icon" type="image/png" href="https://japanese-document.github.io/memo/images/favicon.png" />
    <title>Apolloメモ</title>
    <link rel="stylesheet" href="https://japanese-document.github.io/memo/app.css?v=5909b1d1-6e6f-5bcd-b03d-fa7e680a46a6" type="text/css"  media="all" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-L9VVC74WWF"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-L9VVC74WWF');
    </script>
  </head>
  <body class="container">
    <div class="left-side"><nav class="index-menu">
<details open="">
<summary>Mac</summary>
<p><a href="https://japanese-document.github.io/memo/mac/command.html" rel="nofollow">⌘</a></p>
<p><a href="https://japanese-document.github.io/memo/mac/page-bottom.html" rel="nofollow">⌘ + ↓でページの一番下に移動する</a></p>
</details>
<details open="">
<summary>Ubuntu</summary>
<p><a href="https://japanese-document.github.io/memo/ubuntu/terminal-input-clear.html" rel="nofollow">Ubuntuのターミナルで入力中の文字列をクリアする方法</a></p>
<p><a href="https://japanese-document.github.io/memo/ubuntu/failed-to-connect-is-docker-running.html" rel="nofollow">VSCodeでDockerに接続することができない</a></p>
</details>
<details open="">
<summary>AI</summary>
<p><a href="https://japanese-document.github.io/memo/ai/programming-with-chatgpt.html" rel="nofollow">ChatGPTとプログラミングした感想</a></p>
</details>
<details open="">
<summary>Vim</summary>
<p><a href="https://japanese-document.github.io/memo/vim/delete-around-curly-braces.html" rel="nofollow">Vimでカーソルがある{}ブロックを削除する</a></p>
</details>
<details open="">
<summary>React</summary>
<p><a href="https://japanese-document.github.io/memo/react/ref-current-is-null.html" rel="nofollow">Reactでrefオブジェクトのcurrentがnullの時確認すること</a></p>
<p><a href="https://japanese-document.github.io/memo/react/styled-components-not-appling-style-to-component.html" rel="nofollow">styled-componentsでコンポーネントにスタイルが適用されない</a></p>
<p><a href="https://japanese-document.github.io/memo/react/styled-components-not-passing-props.html" rel="nofollow">styled-components用のpropsをコンポーネントに渡さない</a></p>
<p><a href="https://japanese-document.github.io/memo/react/tanstack-table.html" rel="nofollow">TanStack Tableメモ</a></p>
</details>
<details open="">
<summary>Go</summary>
<p><a href="https://japanese-document.github.io/memo/go/generics-builtin-packages.html" rel="nofollow">ジェネリクスに対応したビルトインパッケージ</a></p>
<p><a href="https://japanese-document.github.io/memo/go/interface-unions.html" rel="nofollow">Goのinterfaceのunionsの例</a></p>
<p><a href="https://japanese-document.github.io/memo/go/gqlgen-generate-does-not-work.html" rel="nofollow">gqlgen generateがうまくいかない</a></p>
<p><a href="https://japanese-document.github.io/memo/go/gqlgen-get-shallow-data.html" rel="nofollow">gqlgenで浅くデータを取得する方法</a></p>
<p><a href="https://japanese-document.github.io/memo/go/gqlgen-set-null-to-property.html" rel="nofollow">gqlgenの入力変数のプロパティにnullをセットする方法</a></p>
<p><a href="https://japanese-document.github.io/memo/go/array-unshift.html" rel="nofollow">GoでArray.unshift()を行う</a></p>
<p><a href="https://japanese-document.github.io/memo/go/sqlmock.html" rel="nofollow">sqlmockメモ</a></p>
<p><a href="https://japanese-document.github.io/memo/go/sqlx-join-table.html" rel="nofollow">sqlxでjoinしたテーブルのデータを構造体にマッピングする</a></p>
</details>
<details open="">
<summary>JavaScript</summary>
<p><a href="https://japanese-document.github.io/memo/javascript/function-composition-using-reduce.html" rel="nofollow">reduceを使った関数合成</a></p>
<p><a href="https://japanese-document.github.io/memo/javascript/graphql-codegen-gql-ts-error.html" rel="nofollow">graphql-codegenを実行するとgql.tsがエラーになる</a></p>
<p><a href="https://japanese-document.github.io/memo/javascript/graphql-codegen-client-preset.html" rel="nofollow">Apolloとgraphql-codegenを使う</a></p>
<p><a href="https://japanese-document.github.io/memo/javascript/url-can-parse.html" rel="nofollow">JavaScriptでURLが有効か判別する</a></p>
</details>
<details open="">
<summary>VSCode</summary>
<p><a href="https://japanese-document.github.io/memo/vscode/jump-to-error.html" rel="nofollow">VSCodeでエラーにジャンプするにはF8</a></p>
<p><a href="https://japanese-document.github.io/memo/vscode/folding.html" rel="nofollow">折り畳み</a></p>
</details>
<details open="">
<summary>GraphQL</summary>
<p><a href="https://japanese-document.github.io/memo/graphql/Interfaces-and-union.html" rel="nofollow">GraphQLのインターフェイスとユニオンの違い</a></p>
<p><a href="https://japanese-document.github.io/memo/graphql/gqlgen-divide-schema-and-resolver.html" rel="nofollow">gqlgenのschemaとresolverを分割する</a></p>
<p><a href="https://japanese-document.github.io/memo/graphql/make-types-from-introspection.html" rel="nofollow">Introspectionから型を生成する</a></p>
<p><a href="https://japanese-document.github.io/memo/graphql/apollo.html" rel="nofollow">Apolloメモ</a></p>
<p><a href="https://japanese-document.github.io/memo/graphql/error-using-graphql-codegen.html" rel="nofollow">graphql-codegenのエラー</a></p>
</details>
</nav></div>
    <main class="main markdown-body">
      <h1 id="Apolloメモ"><a href="#Apollo%E3%83%A1%E3%83%A2" rel="nofollow">Apolloメモ</a></h1>
<h2><a href="#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88" rel="nofollow">リクエスト</a></h2>
<ul>
<li>
<p>手動でデータを取得するには<a href="https://www.apollographql.com/docs/react/data/queries/#queryresult-interface-refetch" class="Link" rel="nofollow">refetch</a>を使うか、<a href="https://www.apollographql.com/docs/react/data/queries/#manual-execution-with-uselazyquery" class="Link" rel="nofollow">useLazyQuery</a>を使う。</p>
</li>
<li>
<p><a href="https://www.apollographql.com/docs/react/data/suspense#fetching-with-suspense" class="Link" rel="nofollow">useSuspenseQuery</a>を<code>&lt;Suspense&gt;</code>の子コンポーネントで使うと、リクエスト中はfallbackが表示される。</p>
</li>
<li>
<p><code>&lt;Suspense&gt;</code>の中に<code>&lt;Suspense&gt;</code>を入れると各<code>&lt;Suspense&gt;</code>内でデータを取得すると上位の<code>&lt;Suspense&gt;</code>でのデータ取得を待つ必要があるので表示が遅くなります。<br>
その場合は<a href="https://www.apollographql.com/docs/react/data/suspense/#avoiding-request-waterfalls" class="Link" rel="nofollow">useLoadableQuery、useBackgroundQuery、useReadQuery</a>を使います。リクエストをスキップするには<a href="https://www.apollographql.com/docs/react/api/react/hooks/#skiptoken" class="Link" rel="nofollow">skipToken</a>を指定します。</p>
</li>
<li>
<p>Reactのスコープの外やルーターと組み合わせて使う場合は<a href="https://www.apollographql.com/docs/react/data/suspense/#initiating-queries-outside-react" class="Link" rel="nofollow">preloadQuery</a>を使う。</p>
</li>
<li>
<p>mutationの結果(loading、errors)を初期化したい場合は<a href="https://www.apollographql.com/docs/react/data/mutations/#resetting-mutation-status" class="Link" rel="nofollow">reset</a>を使う。(キャッシュは初期化されない)</p>
</li>
<li>
<p>取得してデータを変更してはいけない。</p>
</li>
</ul>
<h2><a href="#%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5" rel="nofollow">キャッシュ</a></h2>
<ul>
<li>
<p>クエリとそのパラメータごとにキャッシュされる。</p>
</li>
<li>
<p>同じクエリはキャッシュを利用することができるが、別のクエリで使用するには設定が必要<br>
<a href="https://www.apollographql.com/docs/react/caching/advanced-topics/#cache-redirects" rel="nofollow">https://www.apollographql.com/docs/react/caching/advanced-topics/#cache-redirects</a></p>
</li>
<li>
<p>mutationの結果をキャッシュに反映したい場合は、mutationのレスポンスで<a href="https://www.apollographql.com/docs/react/data/mutations/#include-modified-objects-in-mutation-responses" class="Link" rel="nofollow"><code>__typename</code>と<code>id</code></a>(mutationの戻り値だけではidに対応するデータを取得する目的のキャッシュを変更することはできるが、キャッシュされている配列の中に存在するデータを変更することはできない)を返すか、<a href="https://www.apollographql.com/docs/react/data/mutations/#the-update-function" class="Link" rel="nofollow">update関数を定義する</a>か、<a href="https://www.apollographql.com/docs/react/data/mutations/#refetching-after-update" class="Link" rel="nofollow">onQueryUpdatedコールバック関数を定義する</a>。</p>
</li>
<li>
<p>手動でキャッシュを更新したい場合、<a href="https://www.apollographql.com/docs/react/data/refetching/" class="Link" rel="nofollow">client.refetchQueries()</a>を使う。<br>
Reactではclientは<a href="https://www.apollographql.com/docs/react/api/react/hooks/#useapolloclient" class="Link" rel="nofollow">useApolloClient</a>で取得する。</p>
</li>
</ul>
<h3><a href="#%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E3%82%AD%E3%83%BC" rel="nofollow">キャッシュのキー</a></h3>
<ul>
<li>
<p>デフォルトでは<code>__typename</code>と<code>id</code>でデータを特定してキャッシュに反映する。<br>
<a href="https://www.apollographql.com/docs/react/why-apollo/#zero-config-caching" rel="nofollow">https://www.apollographql.com/docs/react/why-apollo/#zero-config-caching</a></p>
</li>
<li>
<p>キーに使用するプロパティやキーの生成方法を変更することができる。
<a href="https://www.apollographql.com/docs/react/caching/cache-interaction" rel="nofollow">https://www.apollographql.com/docs/react/caching/cache-interaction</a></p>
</li>
</ul>
<h3><a href="#%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%82%92%E6%93%8D%E4%BD%9C%E3%81%99%E3%82%8B" rel="nofollow">キャッシュを操作する</a></h3>
<p>以下はクエリのみ操作する。つまり、サーバにリクエストが送信されない。
Apollo Clientは<a href="https://www.apollographql.com/docs/react/api/cache/InMemoryCache/" class="Link" rel="nofollow">InMemoryCache</a>をプロキシしている。</p>
<h4><a href="#%E3%82%AF%E3%82%A8%E3%83%AA%E3%81%A7%E6%93%8D%E4%BD%9C" rel="nofollow">クエリで操作</a></h4>
<p><a href="https://www.apollographql.com/docs/react/caching/cache-interaction#readquery" class="Link" rel="nofollow">client.readQuery</a> / <a href="https://www.apollographql.com/docs/react/caching/cache-interaction#writequery" class="Link" rel="nofollow">client.writeQuery</a> / <a href="https://www.apollographql.com/docs/react/api/cache/InMemoryCache/#updatequery" class="Link" rel="nofollow">client.updateQuery</a></p>
<ul>
<li>
<p><code>client.writeQuery</code>で既存のデータを上書きすることができる。データの一部を渡した場合、その部分のみ上書きされる。</p>
</li>
<li>
<p><code>updateFragment</code>と<code>updateQuery</code>はデータを取得して、それを基に上書きする処理ができる。</p>
</li>
</ul>
<h5 id="readQuery"><a href="#readQuery" rel="nofollow">readQuery</a></h5>
<p>キャッシュに対応する値がない場合は<code>null</code>を返す。</p>
<h4><a href="#%E3%83%95%E3%83%A9%E3%82%B0%E3%83%A1%E3%83%B3%E3%83%88%E3%81%A7%E6%93%8D%E4%BD%9C" rel="nofollow">フラグメントで操作</a></h4>
<p><code>client.readFragment</code> / <code>client.writeFragment</code> / <a href="https://www.apollographql.com/docs/react/api/cache/InMemoryCache/#updatefragment" class="Link" rel="nofollow">client.updateFragment</a> / <code>client.useFragment</code></p>
<h4><a href="#%E6%89%8B%E5%8B%95%E3%81%A7%E6%93%8D%E4%BD%9C" rel="nofollow">手動で操作</a></h4>
<p><a href="https://www.apollographql.com/docs/react/caching/cache-interaction/#using-cachemodify" class="Link" rel="nofollow">cache.modify</a></p>
<p><a href="https://www.apollographql.com/docs/react/caching/cache-interaction#obtaining-an-objects-cache-id" class="Link" rel="nofollow">cache.identify(obj)</a>は<code>obj</code>のidを取得する。</p>
<p>refのフィールドにアクセスるには<code>readField()</code>を使う。</p>
<p>useMutationで使用するとサーバへのアクセスなしにキャッシュを変更することができる。</p>
<h4><a href="#%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%81%8B%E3%82%89%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B" rel="nofollow">キャッシュからデータを削除する</a></h4>
<p><code>cache.evict({ id: &#39;foo-id&#39; })</code>はidが<code>&#39;foo-id&#39;</code>のデータをキャッシュから削除します。
<code>cache.gc()</code>で孤立したデータを削除する。</p>
<p>すべてのキャッシュをクリアするには<code>client.clearStore()</code>を使う。</p>
<h4 id="fetchMore"><a href="#fetchMore" rel="nofollow">fetchMore</a></h4>
<ul>
<li>
<p>パラメータを無視してクエリ毎にキャッシュするには<code>typePolicies</code>を設定する。</p>
</li>
<li>
<p>キャッシュされたデータの取得方法を変更するには<code>typePolicies</code>の<code>read</code>を変更する。</p>
</li>
</ul>
<h2><a href="#%E3%83%95%E3%83%A9%E3%82%B0%E3%83%A1%E3%83%B3%E3%83%88" rel="nofollow">フラグメント</a></h2>
<ul>
<li>
<p><a href="https://graphql.org/learn/queries/#fragments" class="Link" rel="nofollow">フラグメント</a>は再利用可能な型の部分集合</p>
</li>
<li>
<p>以下のように埋め込むことができる</p>
</li>
</ul>
<pre><code>const FooFragment = gql`
  fragment FooFragment on Bar {
    name
  }
`;

const client = new ApolloClient({
  uri: &#39;https://example.com/&#39;,
  cache: new InMemoryCache({
    fragments: createFragmentRegistry(gql`
      ${UserFragment}
    `),
  }),
});
</code></pre>
<ul>
<li>
<p>フラグメントはそれを使うクエリに<a href="https://www.apollographql.com/docs/react/data/fragments/#example-usage" class="Link" rel="nofollow">埋め込む</a>か<a class="Link">fragmentsオプション</a>に登録する必要がある。</p>
</li>
<li>
<p>フラグメントをコンポーネントに関連付ける<a href="https://www.apollographql.com/docs/react/data/fragments/#creating-colocated-fragments" class="Link" rel="nofollow">例</a></p>
</li>
<li>
<p><a href="https://www.apollographql.com/docs/react/data/fragments/#using-fragments-with-unions-and-interfaces" class="Link" rel="nofollow">possibleTypes</a>にinterfaceやunionの親子関係を記述する。<br>
<a href="https://the-guild.dev/graphql/codegen/plugins/other/fragment-matcher" rel="nofollow">https://the-guild.dev/graphql/codegen/plugins/other/fragment-matcher</a></p>
</li>
<li>
<p><a href="https://www.apollographql.com/docs/react/data/fragments/#usefragment" class="Link" rel="nofollow">useFragment</a>を使うとフラグメントに関連したデータを効率的に取得することができます。</p>
</li>
</ul>
<h2 id="type"><a href="#type" rel="nofollow">type</a></h2>
<ul>
<li>以下のように型のフィールドに<a href="https://graphql.org/learn/schema/#arguments" class="Link" rel="nofollow">引数</a>を渡すことができる</li>
</ul>
<pre><code>type Car {
  id: ID!
  name: String!
  size(unit: LengthUnit = METER): Float
}
</code></pre>
<h2><a href="#%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%86%E3%82%A3%E3%83%96" rel="nofollow">ディレクティブ</a></h2>
<h3 id="GraphQL標準のディレクティブ"><a href="#GraphQL%E6%A8%99%E6%BA%96%E3%81%AE%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%86%E3%82%A3%E3%83%96" rel="nofollow">GraphQL標準のディレクティブ</a></h3>
<p><a href="https://spec.graphql.org/June2018/#sec-Type-System.Directives" rel="nofollow">https://spec.graphql.org/June2018/#sec-Type-System.Directives</a></p>
<h3 id="_client"><a href="#_client" rel="nofollow">@client</a></h3>
<p>フィールドがローカルに存在するデータであり、そのデータ取得がサーバーへのクエリではなくクライアント側のキャッシュまたはローカルストアから行われることを示すフラグとして機能します。</p>
<h3 id="_connect"><a href="#_connect" rel="nofollow">@connect</a></h3>
<p><code>@connection</code>ディレクティブを付与すると、同じクエリでも<code>@connection</code>ディレクティブに与えられた値毎に別のクエリとして区別されます。これによって、同じクエリで用途に応じて複数の値をキャッシュすることができます。</p>
<h3 id="_defer"><a href="#_defer" rel="nofollow">@defer</a></h3>
<p>指定したフィールドを遅延的に取得する。</p>
<h3 id="_export"><a href="#_export" rel="nofollow">@export</a></h3>
<p>指定したフィールドを変数として使うことができるようにする。</p>
<h3 id="_nonreactive"><a href="#_nonreactive" rel="nofollow">@nonreactive</a></h3>
<p>指定したフィールドが変更されても再レンダリングが発生しないようにする。</p>

    </main>
    <div class="right-side"><nav class="header-list"><p class="h1"><a href="#Apollo%E3%83%A1%E3%83%A2" rel="nofollow">Apolloメモ
</a></p>
<p class="h2"><a href="#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88" rel="nofollow">リクエスト
</a></p>
<p class="h2"><a href="#%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5" rel="nofollow">キャッシュ
</a></p>
<p class="h3"><a href="#%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E3%82%AD%E3%83%BC" rel="nofollow">キャッシュのキー
</a></p>
<p class="h3"><a href="#%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%82%92%E6%93%8D%E4%BD%9C%E3%81%99%E3%82%8B" rel="nofollow">キャッシュを操作する
</a></p>
<p class="h4"><a href="#%E3%82%AF%E3%82%A8%E3%83%AA%E3%81%A7%E6%93%8D%E4%BD%9C" rel="nofollow">クエリで操作
</a></p>
<p class="h4"><a href="#%E3%83%95%E3%83%A9%E3%82%B0%E3%83%A1%E3%83%B3%E3%83%88%E3%81%A7%E6%93%8D%E4%BD%9C" rel="nofollow">フラグメントで操作
</a></p>
<p class="h4"><a href="#%E6%89%8B%E5%8B%95%E3%81%A7%E6%93%8D%E4%BD%9C" rel="nofollow">手動で操作
</a></p>
<p class="h4"><a href="#%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%81%8B%E3%82%89%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B" rel="nofollow">キャッシュからデータを削除する
</a></p>
<p class="h4"><a href="#fetchMore" rel="nofollow">fetchMore
</a></p>
<p class="h2"><a href="#%E3%83%95%E3%83%A9%E3%82%B0%E3%83%A1%E3%83%B3%E3%83%88" rel="nofollow">フラグメント
</a></p>
<p class="h2"><a href="#type" rel="nofollow">type
</a></p>
<p class="h2"><a href="#%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%86%E3%82%A3%E3%83%96" rel="nofollow">ディレクティブ
</a></p>
<p class="h3"><a href="#GraphQL%E6%A8%99%E6%BA%96%E3%81%AE%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%86%E3%82%A3%E3%83%96" rel="nofollow">GraphQL標準のディレクティブ
</a></p>
<p class="h3"><a href="#_client" rel="nofollow">@client
</a></p>
<p class="h3"><a href="#_connect" rel="nofollow">@connect
</a></p>
<p class="h3"><a href="#_defer" rel="nofollow">@defer
</a></p>
<p class="h3"><a href="#_export" rel="nofollow">@export
</a></p>
<p class="h3"><a href="#_nonreactive" rel="nofollow">@nonreactive
</a></p></nav></div>
    <footer class="footer markdown-body">
      <a href="/memo">Top</a>
    </footer>
  </body>
</html>